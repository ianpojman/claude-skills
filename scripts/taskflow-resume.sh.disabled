#!/bin/bash
# TaskFlow Resume - Resume work on a specific task by ID

set -e

# Check if task ID provided
if [ -z "$1" ]; then
    echo "Usage: ./scripts/taskflow-resume.sh <TASK-ID>"
    echo ""
    echo "Examples:"
    echo "  ./scripts/taskflow-resume.sh VAL-001"
    echo "  ./scripts/taskflow-resume.sh SPARSE-001"
    echo "  ./scripts/taskflow-resume.sh CAT-001"
    exit 1
fi

TASK_ID="$1"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                      RESUME TASK: $TASK_ID                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Function to extract task section from markdown file
extract_task_section() {
    local file="$1"
    local task_id="$2"

    if [ ! -f "$file" ]; then
        return 1
    fi

    # Find the task section and extract it
    awk -v task="$task_id" '
        BEGIN { in_section=0; found=0 }
        /^###/ {
            if (in_section) {
                exit
            }
            if ($0 ~ task) {
                in_section=1
                found=1
            }
        }
        in_section { print }
        END { exit !found }
    ' "$file"
}

# Search in ACTIVE.md first
echo "ğŸ“ Searching ACTIVE.md..."
if extract_task_section "ACTIVE.md" "$TASK_ID" > /tmp/taskflow-resume-active.txt 2>/dev/null; then
    echo "âœ… Found in ACTIVE.md"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cat /tmp/taskflow-resume-active.txt
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    FOUND_IN_ACTIVE=1
else
    echo "âš ï¸  Not found in ACTIVE.md"
    FOUND_IN_ACTIVE=0
fi

# Search in BACKLOG.md
echo "ğŸ“ Searching BACKLOG.md..."
if extract_task_section "BACKLOG.md" "$TASK_ID" > /tmp/taskflow-resume-backlog.txt 2>/dev/null; then
    echo "âœ… Found in BACKLOG.md"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cat /tmp/taskflow-resume-backlog.txt
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    FOUND_IN_BACKLOG=1
else
    echo "âš ï¸  Not found in BACKLOG.md"
    FOUND_IN_BACKLOG=0
fi

# Check if task not found anywhere
if [ "$FOUND_IN_ACTIVE" -eq 0 ] && [ "$FOUND_IN_BACKLOG" -eq 0 ]; then
    echo ""
    echo "âŒ Task $TASK_ID not found in ACTIVE.md or BACKLOG.md"
    echo ""
    echo "ğŸ’¡ Tips:"
    echo "  â€¢ Check task ID spelling (case-sensitive)"
    echo "  â€¢ Use 'taskflow list' to see all active tasks"
    echo "  â€¢ Use 'taskflow search <keyword>' to search by description"
    exit 1
fi

# Look for detailed documentation in docs/active/
echo "ğŸ“ Checking for detailed documentation..."
DETAIL_FILES=$(find docs/active -type f -name "*${TASK_ID}*" 2>/dev/null || true)

if [ -n "$DETAIL_FILES" ]; then
    echo "âœ… Found detailed documentation:"
    echo ""
    for file in $DETAIL_FILES; do
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“„ $file"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        head -50 "$file"
        echo ""
        echo "... (showing first 50 lines, see $file for complete details)"
        echo ""
    done
else
    echo "â„¹ï¸  No detailed documentation found in docs/active/"
    echo ""
fi

# Look for related session notes
echo "ğŸ“ Checking for related session notes..."
SESSION_NOTES=$(grep -l "$TASK_ID" docs/SESSION-*.md 2>/dev/null || true)

if [ -n "$SESSION_NOTES" ]; then
    echo "âœ… Found in session notes:"
    echo ""
    for note in $SESSION_NOTES; do
        echo "  â€¢ $(basename "$note")"
    done
    echo ""
else
    echo "â„¹ï¸  No session notes mention this task"
    echo ""
fi

# Show git context
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ Current Git Context"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
echo "  Commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
echo "  Status: $(git status --short 2>/dev/null | wc -l | xargs) modified files"
echo ""

# Cleanup temp files
rm -f /tmp/taskflow-resume-active.txt /tmp/taskflow-resume-backlog.txt

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ’¡ Next Steps:"
echo "  â€¢ Review the context above"
echo "  â€¢ Check validation commands or quick status checks"
echo "  â€¢ Update ACTIVE.md when making progress"
echo "  â€¢ Use 'taskflow capture' to record session notes"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
