#!/bin/bash
# TaskFlow List - Show all active tasks with status

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                      TASKFLOW - ACTIVE TASKS                         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if [ ! -f "ACTIVE.md" ]; then
    echo "âŒ ACTIVE.md not found"
    exit 1
fi

# Extract all task headers (### lines with issue IDs)
echo "ðŸ“‹ Active Tasks:"
echo ""

grep "^###" ACTIVE.md | grep -E '[A-Z]+-[0-9]+' | while IFS= read -r line; do
    # Extract issue ID
    issue_id=$(echo "$line" | grep -oE '[A-Z]+-[0-9]+' | head -1)

    # Extract status emoji
    status_emoji=""
    if echo "$line" | grep -q "ðŸ”´"; then
        status_emoji="ðŸ”´"
    elif echo "$line" | grep -q "â³"; then
        status_emoji="â³"
    elif echo "$line" | grep -q "âœ…"; then
        status_emoji="âœ…"
    elif echo "$line" | grep -q "ðŸ†•"; then
        status_emoji="ðŸ†•"
    fi

    # Extract description (remove ###, emojis, and issue ID)
    description=$(echo "$line" | sed 's/^###[[:space:]]*//' | sed "s/${issue_id}:[[:space:]]*//" | sed 's/ðŸ”´//' | sed 's/â³//' | sed 's/âœ…//' | sed 's/ðŸ†•//' | sed 's/(IN PROGRESS)//' | sed 's/(COMPLETE)//' | xargs)

    # Display
    printf "  %s %-20s %s\n" "$status_emoji" "$issue_id" "$description"
done

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Count tasks by status
total=$(grep "^###" ACTIVE.md | grep -cE '[A-Z]+-[0-9]+' || echo "0")
in_progress=$(grep "^###" ACTIVE.md | grep -c "â³" || echo "0")
completed=$(grep "^###" ACTIVE.md | grep -c "âœ…" || echo "0")
new_tasks=$(grep "^###" ACTIVE.md | grep -c "ðŸ†•" || echo "0")
blocked=$(grep "^###" ACTIVE.md | grep -c "ðŸ”´" || echo "0")

echo ""
echo "ðŸ“Š Summary:"
echo "  â€¢ Total: $total tasks"
echo "  â€¢ In Progress: $in_progress â³"
echo "  â€¢ Completed: $completed âœ…"
echo "  â€¢ New/Ready: $new_tasks ðŸ†•"
echo "  â€¢ Blocked: $blocked ðŸ”´"
echo ""

# Show git context
if git rev-parse --git-dir > /dev/null 2>&1; then
    branch=$(git branch --show-current)
    commit=$(git rev-parse --short HEAD)
    echo "ðŸ”§ Git: $branch @ $commit"
    echo ""
fi

echo "ðŸ’¡ Use 'taskflow search <keyword>' to find specific issues"
