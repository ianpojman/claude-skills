#!/bin/bash
# TaskFlow Init - Prime context with ACTIVE.md and BACKLOG.md for AI sessions

set -e
cd "$(dirname "$0")/.."

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                      TASKFLOW INIT                                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if files exist
if [ ! -f "ACTIVE.md" ] || [ ! -f "BACKLOG.md" ]; then
    echo "âŒ Error: ACTIVE.md or BACKLOG.md not found"
    echo ""
    echo "TaskFlow requires:"
    echo "  â€¢ ACTIVE.md - Current sprint tasks"
    echo "  â€¢ BACKLOG.md - Future work"
    echo ""
    echo "Run this from project root directory."
    exit 1
fi

# Show quick status
echo "ğŸ“Š Current State:"
./scripts/taskflow-status.sh
echo ""

# Generate context prompt for AI
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ SESSION RESUMPTION PROMPT"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Copy and paste this to Claude to resume work:"
echo ""
echo "---"
echo ""
cat <<'PRIMER'
Resuming work on this project. Please load TaskFlow context:

1. Read ACTIVE.md - shows current sprint tasks and recent session notes

Note: BACKLOG.md has detailed plans (28k tokens). Only read specific sections when needed using links from ACTIVE.md.

Key TaskFlow commands:
- taskflow status - Quick one-line status
- taskflow handoff "summary" - End session with summary

Please start by reading ACTIVE.md to see what we're currently working on.
PRIMER
echo ""
echo "---"
echo ""
echo "ğŸ’¡ Or just ask Claude: 'show active' to auto-load ACTIVE.md"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Show recent session notes if they exist
if grep -q "^### ğŸ“… Session Notes" ACTIVE.md 2>/dev/null; then
    echo "ğŸ“… Recent Session Notes:"
    echo ""
    # Show last session note (last occurrence before end of file)
    awk '/^### ğŸ“… Session Notes/{p=1} p{print} /^---$/ && p{exit}' ACTIVE.md | tail -20
    echo ""
fi

# Show active tasks summary
echo "ğŸš€ Active Tasks Summary:"
echo ""
grep "^### " ACTIVE.md | grep -v "ğŸ“… Session Notes" | head -10 | while IFS= read -r line; do
    echo "  â€¢ ${line#### }"
done
echo ""

# Git context
if git rev-parse --git-dir > /dev/null 2>&1; then
    echo "ğŸ”§ Git Context:"
    echo "  Branch: $(git branch --show-current)"
    echo "  Commit: $(git rev-parse --short HEAD)"
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        echo "  Status: âš ï¸ Uncommitted changes"
    else
        echo "  Status: âœ… Clean"
    fi
    echo ""
fi

echo "âœ… TaskFlow context ready!"
echo ""
echo "Next steps:"
echo "  1. Copy the context primer above to Claude"
echo "  2. Or just say: 'show active'"
echo "  3. Start working on tasks"
echo "  4. At end: ./scripts/taskflow-handoff.sh"
