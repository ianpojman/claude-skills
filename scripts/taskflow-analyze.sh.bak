#!/bin/bash
# TaskFlow Analyze - Token usage analysis

set -e

cd "$(dirname "$0")/.."

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    TASKFLOW TOKEN ANALYSIS                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo

echo "TOKEN USAGE:"
ACTIVE_BYTES=$(wc -c < ACTIVE.md)
BACKLOG_BYTES=$(wc -c < BACKLOG.md)
ACTIVE_TOKENS=$((ACTIVE_BYTES / 4))
BACKLOG_TOKENS=$((BACKLOG_BYTES / 4))

echo "  ACTIVE.md:   ${ACTIVE_TOKENS} tokens $([ $ACTIVE_TOKENS -lt 2000 ] && echo 'âœ…' || echo 'âŒ') (budget: 2K)"
echo "  BACKLOG.md:  ${BACKLOG_TOKENS} tokens $([ $BACKLOG_TOKENS -lt 10000 ] && echo 'âœ…' || echo 'âŒ') (budget: 10K)"
echo

if [ $BACKLOG_TOKENS -gt 10000 ]; then
    OVER=$((BACKLOG_TOKENS - 10000))
    echo "âš ï¸  BACKLOG.md is ${OVER} tokens over budget!"
    echo
fi

echo "ARCHIVAL CANDIDATES (âœ… Complete):"
grep -B2 "^### Status:.*âœ…\|^### Status:.*Complete" BACKLOG.md 2>/dev/null | grep "^## " | sed 's/^## /  â€¢ /' || echo "  None found"
echo

if [ $BACKLOG_TOKENS -gt 10000 ]; then
    echo "ğŸ’¡ RECOMMENDATION: Run ./scripts/taskflow-compact.sh"
fi
